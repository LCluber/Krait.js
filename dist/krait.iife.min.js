/** MIT License
* 
* Copyright (c) 2015 Ludovic CLUBER 
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* http://kraitjs.lcluber.com
*/

var Krait=function(t){"use strict";function n(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function e(t,n){return!!o(t)&&(n&&t>=0&&t<=255||t>=0&&t<=127)}function o(t){return t===parseInt(t,10)}function r(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function i(t){return t<10?"0"+t:t}function s(){var t=new Date,n=[i(t.getMonth()+1),i(t.getDate()),t.getFullYear().toString().substr(-2)],e=[i(t.getHours()),i(t.getMinutes()),i(t.getSeconds())];return n.join("/")+" "+e.join(":")}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(){function t(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(n,e,o){return e&&t(n.prototype,e),o&&t(n,o),n}}(),l=(function(){function t(){n(this,t)}a(t,null,[{key:"isJSON",value:function(t){var n=t.replace(/(\r\n|\n|\r|\t)/gm,"");try{n=JSON.parse(t)}catch(t){return console.log(t),!1}return n}},{key:"isFunction",value:function(t){var n={};return t&&"[object Function]"===n.toString.call(t)}},{key:"isObject",value:function(t){return null!==t&&(this.isFunction(t)||"object"===(void 0===t?"undefined":u(t)))}},{key:"isASCII",value:function(t,n){return(n?/^[\x00-\xFF]*$/:/^[\x00-\x7F]*$/).test(t)}},{key:"isInteger",value:function(t){return t===parseInt(t,10)}}])}(),function(){function t(){n(this,t)}a(t,null,[{key:"scrollToBottom",value:function(t){t.scrollTop=t.scrollHeight}},{key:"findById",value:function(t){return document.getElementById(t)}},{key:"showById",value:function(t){this.findById(t).style.display="block"}},{key:"hideById",value:function(t){this.findById(t).style.display="none"}},{key:"showOverflow",value:function(){document.body.style.overflow="visible"}},{key:"hideOverflow",value:function(){document.body.style.overflow="hidden"}},{key:"getInputValue",value:function(t){return this.findById(t).value}},{key:"clearInputValue",value:function(t){this.findById(t).value=""}},{key:"focusOn",value:function(t){this.findById(t).focus()}},{key:"addHTMLElement",value:function(t,n,e){var o=document.createElement(n);return void 0!==e&&Object.keys(e).forEach(function(t){"textContent"===t?o.textContent=e[t]:o.setAttribute(t,e[t])}),t.appendChild(o),o}}])}(),function(){function t(e,o){n(this,t),this.data=o,this.element=e,this.element.value=o,this.element.addEventListener("change",this,!1)}a(t,[{key:"handleEvent",value:function(t){switch(t.type){case"change":this.change(this.element.value)}}},{key:"change",value:function(t){this.data=t,this.element.value=t}}])}(),function(){function t(){n(this,t)}return a(t,null,[{key:"ucfirst",value:function(t){return t.charAt(0).toUpperCase()+t.slice(1)}},{key:"toASCII",value:function(t){return t.charCodeAt(0)}}]),t}()),c=function(){function t(){n(this,t)}return a(t,null,[{key:"call",value:function(t){var n=this;return new Promise(function(e,o){var r=new XMLHttpRequest;n.noCache&&(t+="?cache="+(new Date).getTime()),r.open(n.method,t,n.async),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){4==r.readyState&&(200==r.status?(console.log("xhr done successfully ("+t+")"),e(r.responseText)):(console.log("error","xhr failed ("+t+")"),o(r.status)))},console.log("xhr processing starting ("+t+")"),r.send()})}}]),t}();c.method="GET",c.async=!0,c.noCache=!1;var h=function(){function t(){n(this,t)}return a(t,null,[{key:"load",value:function(t){return c.call(t)}},{key:"removeTrailingSlash",value:function(t){return t.replace(/\/+$/,"")}},{key:"getName",value:function(t){return t.replace(/^.*[\\\/]/,"")}},{key:"getExtension",value:function(t){return t.split(".").pop()}},{key:"getDirectory",value:function(t){return t.replace(/[^\\\/]*$/,"")}},{key:"checkExtension",value:function(t,n){var e=!0,o=!1,r=void 0;try{for(var i,s=n[Symbol.iterator]();!(e=(i=s.next()).done);e=!0)if(t===i.value)return!0}catch(t){o=!0,r=t}finally{try{!e&&s.return&&s.return()}finally{if(o)throw r}}return!1}}]),t}(),f=(function(){function t(){n(this,t)}a(t,null,[{key:"load",value:function(t){return new Promise(function(n,e){var o=new Image;o.src=t,o.name=h.getName(t),console.log("xhr processing starting ("+t+")"),o.addEventListener("load",function(){console.log("xhr done successfully ("+t+")"),n(o)}),o.addEventListener("error",function(){console.log("error","xhr failed ("+t+")"),e(new Error("xhr failed ("+t+")"))})})}}])}(),function(){function t(){n(this,t)}a(t,null,[{key:"load",value:function(t){return new Promise(function(n,e){var o=new Audio;o.src=t,console.log("xhr processing starting ("+t+")"),o.addEventListener("canplaythrough",function(){console.log("xhr done successfully ("+t+")"),n(o)},!1),o.addEventListener("canplay",function(){console.log("xhr done successfully ("+t+")"),n(o)},!1),o.addEventListener("error",function(){console.log("error","xhr failed ("+t+")"),e(new Error("xhr failed ("+t+")"))},!1)})}}])}(),function(){function t(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(n,e,o){return e&&t(n.prototype,e),o&&t(n,o),n}}()),p={info:{id:1,name:"info",color:"#28a745"},trace:{id:2,name:"trace",color:"#17a2b8"},warn:{id:3,name:"warn",color:"#ffc107"},error:{id:4,name:"error",color:"#dc3545"},off:{id:99,name:"off",color:null}},d=function(){function t(n,e){r(this,t),this.id=n.id,this.name=n.name,this.color=n.color,this.content=e,this.date=s()}return f(t,[{key:"display",value:function(t){console[this.name]("%c["+t+"] "+this.date+" : ","color:"+this.color+";",this.content)}}]),t}(),y=function(){function t(n,e){r(this,t),this.messages=[],this.name=n,this.messages=[],this._level=e}return f(t,[{key:"info",value:function(t){this.log(p.info,t)}},{key:"trace",value:function(t){this.log(p.trace,t)}},{key:"warn",value:function(t){this.log(p.warn,t)}},{key:"error",value:function(t){this.log(p.error,t)}},{key:"log",value:function(t,n){var e=new d(t,n);this.messages.push(e),this._level.id<=e.id&&e.display(this.name)}},{key:"level",set:function(t){this._level=p.hasOwnProperty(t)?p[t]:this._level},get:function(){return this._level.name}}]),t}(),v=function(){function t(){r(this,t)}return f(t,null,[{key:"setLevel",value:function(n){t.level=p.hasOwnProperty(n)?p[n]:t.level;var e=!0,o=!1,r=void 0;try{for(var i,s=t.groups[Symbol.iterator]();!(e=(i=s.next()).done);e=!0)i.value.level=t.level.name}catch(t){o=!0,r=t}finally{try{!e&&s.return&&s.return()}finally{if(o)throw r}}return t.getLevel()}},{key:"getLevel",value:function(){return t.level.name}},{key:"getGroup",value:function(n){var e=!0,o=!1,r=void 0;try{for(var i,s=t.groups[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var u=i.value;if(u.name===n)return u}}catch(t){o=!0,r=t}finally{try{!e&&s.return&&s.return()}finally{if(o)throw r}}return null}},{key:"addGroup",value:function(t){return this.getGroup(t)||this.pushGroup(t)}},{key:"pushGroup",value:function(n){var e=new y(n,t.level);return t.groups.push(e),e}}]),t}();v.level=p.error,v.groups=[];var m=function(){function t(t){this.defaultASCII=t,this.pressed=!1}return t.prototype.down=function(t){t.preventDefault(),this.pressed=!0},t.prototype.up=function(){this.pressed=!1},t}(),g=function(){function t(t,n,e,o,r){this.name=t,this.started=!1,this.defaultControlKeys={ctrl:!!(n&&n.hasOwnProperty("ctrl")&&n.ctrl),alt:!!(n&&n.hasOwnProperty("alt")&&n.alt),shift:!!(n&&n.hasOwnProperty("shift")&&n.shift)},this.ctrlKeys={},this.setInputs(n,e),this.callback=o,r&&(this.callback=this.callback.bind(r)),this.log=v.addGroup("Krait"),this.log.info("Added new command "+this.name)}return t.prototype.start=function(t){if(this.inputs.hasOwnProperty(t.which)){if(this.inputs[t.which].down(t),this.inputsLength>1)for(var n in this.inputs)if(this.inputs.hasOwnProperty(n)&&!this.inputs[n].pressed)return!1;if(this.ctrlKeys.ctrl===t.ctrlKey&&this.ctrlKeys.alt===t.altKey&&this.ctrlKeys.shift===t.shiftKey)return this.started=!0,this.callback(this.started),this.started}return!1},t.prototype.stop=function(t){return!(!this.inputs.hasOwnProperty(t)||(this.inputs[t].up(),!this.started))&&(this.started=!1,this.callback(this.started),!0)},t.prototype.setInputs=function(t,n){this.inputs={},this.ctrlKeys.ctrl=!!(t&&t.hasOwnProperty("ctrl")&&t.ctrl),this.ctrlKeys.alt=!!(t&&t.hasOwnProperty("alt")&&t.alt),this.ctrlKeys.shift=!!(t&&t.hasOwnProperty("shift")&&t.shift);for(var e=0,o=n;e<o.length;e++){var r=o[e];this.inputs.hasOwnProperty("asciiCode")||(this.inputs[r]=new m(r))}this.inputsLength=n.length},t.prototype.getInputsAscii=function(){return Object.keys(this.inputs)},t.prototype.default=function(){this.inputsLength=0;for(var t in this.inputs)if(this.inputs.hasOwnProperty(t)){var n=this.inputs[t].defaultASCII;+t!==n&&(this.inputs[n]=new m(n),delete this.inputs[t],this.inputsLength++,this.copyDefaultToCtrls())}this.log.info(this.name+" is now set to default")},t.prototype.copyDefaultToCtrls=function(){this.ctrlKeys=JSON.parse(JSON.stringify(this.defaultControlKeys))},t}(),w=function(){function t(){this.initListeners(),this.commands=[],this.log=v.addGroup("Krait"),this.listen=!1}return t.prototype.initListeners=function(){var t=this;document.onkeydown=function(n){t.listen&&t.down(n)},document.onkeyup=function(n){t.listen&&t.up(n)}},t.prototype.down=function(t){for(var n=0,e=this.commands;n<e.length;n++)e[n].start(t)},t.prototype.up=function(t){for(var n=0,e=this.commands;n<e.length;n++)e[n].stop(t.which)},t.prototype.start=function(){this.listen=!0},t.prototype.stop=function(){this.listen=!1},t.prototype.addCommand=function(t,n,e,o,r){var i=this.getAsciiCodes(e);return!!i&&(this.commands.push(new g(t,n,i,o,r)),this.commands=this.sortCommands(this.commands),!0)},t.prototype.setInputs=function(t,n,e){var o=this.getAsciiCodes(e);if(o){var r=this.getCommand(t);if(r)return r.setInputs(n,o),this.log.info(r.name+" is now set to "+JSON.stringify(e)),this.commands=this.sortCommands(this.commands),!0}return!1},t.prototype.default=function(t){var n=this.getCommand(t);return!!n&&(n.default(),this.commands=this.sortCommands(this.commands),!0)},t.prototype.sortCommands=function(t){return t.sort(function(t,n){return n.inputsLength-t.inputsLength}),t},t.prototype.getCommand=function(t){for(var n=0,e=this.commands;n<e.length;n++){var o=e[n];if(o.name==t)return o}return null},t.prototype.getCommandInputsAscii=function(t){var n=this.getCommand(t);return!!n&&n.getInputsAscii()},t.prototype.getAsciiCodes=function(t){for(var n=[],e=0,o=t;e<o.length;e++){var r=o[e],i=this.inputValidation(r);if(!i)return!1;n.push(i)}return n},t.prototype.inputValidation=function(t){return o(t)||(t=l.toASCII(t)),e(t,!0)?t:(this.log.error(t+" is not assignable to a valid ASCII code"),!1)},t}();return t.Keyboard=w,t}({});